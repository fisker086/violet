# ============================================
# Nginx 配置 - Violet IM 统一入口
# ============================================
# 聚合所有后端服务，统一对外提供服务
# 
# 重要说明：
# - 客户端不直接连接 SRS 或 MQTT，所有请求都通过 im-server 中转
# - im-server 内部会调用 SRS 的 HTTP API 进行 WebRTC 相关操作
# 
# 代理规则：
#   /api/*          -> im-server:3000 (RESTful API，包括所有业务逻辑)
#   /ws/*            -> im-connect:3001 (WebSocket)
#   /uploads/*       -> im-server:3000 (文件服务)
# ============================================

# 上游服务定义
upstream im_server {
    server im-server:3000;
}

upstream im_connect {
    server im-connect:3001;
}

server {
    listen 80;
    server_name localhost;  # 生产环境改为实际域名

    # 日志配置
    access_log /var/log/nginx/violet_access.log;
    error_log /var/log/nginx/violet_error.log;

    # 允许大请求体（文件上传、SDP 可能较大）
    client_max_body_size 50M;

    # ============================================
    # IM Server API 代理
    # ============================================
    # 代理所有 RESTful API 请求到 im-server
    location /api/ {
        proxy_pass http://im_server;
        proxy_http_version 1.1;
        
        # 设置代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================
    # IM Connect WebSocket 代理
    # ============================================
    # 代理 WebSocket 连接到 im-connect
    location /ws/ {
        proxy_pass http://im_connect;
        proxy_http_version 1.1;
        
        # WebSocket 必需的头
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 超时设置（保持连接）
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # ============================================
    # 文件上传/下载服务
    # ============================================
    # 代理文件服务到 im-server
    # 注意：文件访问通过 /api/upload/{*path}，上传通过 /api/upload
    # 这里提供 /uploads/ 作为简化路径，重写为 /api/upload/
    location /uploads/ {
        # 将 /uploads/ 重写为 /api/upload/
        rewrite ^/uploads/(.*) /api/upload/$1 break;
        
        proxy_pass http://im_server;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 文件服务相关设置
        proxy_buffering off;
        proxy_cache off;
        
        # 超时设置（大文件上传需要更长时间）
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # ============================================
    # 注意：SRS 和 MQTT 不通过 Nginx 直接代理
    # ============================================
    # 客户端不直接连接 SRS 或 MQTT，所有请求都通过 im-server 中转
    # im-server 内部会调用 SRS 的 HTTP API 进行 WebRTC 相关操作
    # 因此不需要在 Nginx 中配置 SRS 的直接代理
    # ============================================

    # ============================================
    # 健康检查端点
    # ============================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }


    # ============================================
    # HTTPS 配置（生产环境）
    # ============================================
    # 生产环境建议启用 HTTPS，取消注释以下配置并配置 SSL 证书
    # 
    # server {
    #     listen 443 ssl http2;
    #     server_name your-domain.com;
    #     
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #     
    #     # SSL 配置
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers HIGH:!aNULL:!MD5;
    #     ssl_prefer_server_ciphers on;
    #     
    #     # 将上面的 location 配置复制到这里
    # }
    # 
    # # HTTP 重定向到 HTTPS
    # server {
    #     listen 80;
    #     server_name your-domain.com;
    #     return 301 https://$server_name$request_uri;
    # }
}

