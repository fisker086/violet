version: '3.8'

# ============================================
# Violet IM 即时通讯系统 - Docker Compose 配置
# ============================================
# 
# 部署说明：
# 1. 所有服务通过 Nginx 统一对外提供服务（端口 80/443）
# 2. 内部服务之间通过 Docker 网络通信
# 3. 生产环境请修改所有默认密码和密钥
# 4. 使用环境变量文件 (.env) 管理配置
#
# 快速启动：
#   docker-compose up -d
#
# 查看日志：
#   docker-compose logs -f [service_name]
#
# 停止服务：
#   docker-compose down
#
# 清理数据（谨慎使用）：
#   docker-compose down -v
# ============================================

services:
  # ============================================
  # MySQL 数据库服务
  # ============================================
  # 存储用户、消息、群组等所有业务数据
  mysql:
    image: mysql:8.0
    container_name: violet-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-violet}
      MYSQL_USER: ${MYSQL_USER:-violet}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-violet123}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d  # 可选的初始化脚本目录
    networks:
      - violet-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-123456}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Redis 缓存服务
  # ============================================
  # 用于缓存用户会话、消息队列等
  redis:
    image: redis:7-alpine
    container_name: violet-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-} --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - violet-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ============================================
  # MQTT 消息代理服务
  # ============================================
  # 用于实时消息推送和系统通知
  mqtt:
    image: eclipse-mosquitto:2.0
    container_name: violet-mqtt
    restart: unless-stopped
    ports:
      - "${MQTT_PORT:-1883}:1883"
      - "${MQTT_WS_PORT:-9001}:9001"  # WebSocket端口
    volumes:
      - ./mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mqtt_data:/mosquitto/data
      - mqtt_log:/mosquitto/log
    networks:
      - violet-network
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-t", "test", "-C", "1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # IM Server 服务（HTTP API 服务）
  # ============================================
  # 提供 RESTful API，处理用户、消息、群组等业务逻辑
  # 对外端口：通过 Nginx 代理，不直接暴露
  # 内部端口：3000（仅用于容器间通信）
  im-server:
    image: ghcr.nju.edu.cn/fisker086/violet-im-server:latest
    container_name: violet-im-server
    restart: unless-stopped
    # 注意：生产环境建议不直接暴露端口，通过 Nginx 统一代理
    # expose:
    #   - "3000"
    ports:
      - "${IM_SERVER_PORT:-3000}:3000"  # 开发环境可保留，生产环境建议注释
    environment:
      - IM_SERVER_CONFIG=/app/config.toml
      - RUST_LOG=${RUST_LOG:-info}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=${MYSQL_USER:-violet}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-violet123}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-violet}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      - SERVER_PORT=3000
      # 重要：JWT_SECRET 必须与 im-connect 服务完全相同，否则 im-connect 无法验证 im-server 生成的 token
      - JWT_SECRET=${JWT_SECRET:-337eb69ef604dec5cdb04481242877fea7db31e4c1fd236497033431ab41d499}
      # 重要：JWT_EXPIRATION_HOURS 必须与 im-connect 服务完全相同，统一 token 过期时间
      - JWT_EXPIRATION_HOURS=${JWT_EXPIRATION_HOURS:-24}
      - SRS_HOST=http://srs:1985
      - SRS_HTTP_HOST=http://srs:8080
      - SRS_WEBRTC_PORT=8000
      - SRS_APP=live
      - SRS_CLIENT_HOST=http://127.0.0.1:1985
      - SRS_CLIENT_HTTP_HOST=http://127.0.0.1:8080
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      mqtt:
        condition: service_healthy
      srs:
        condition: service_healthy
    networks:
      - violet-network

  # ============================================
  # IM Connect 服务（WebSocket 服务）
  # ============================================
  # 提供 WebSocket 连接，处理实时消息推送
  # 对外端口：通过 Nginx 代理，不直接暴露
  # 内部端口：3001（仅用于容器间通信）
  im-connect:
    image: ghcr.nju.edu.cn/fisker086/violet-im-connect:latest
    container_name: violet-im-connect
    restart: unless-stopped
    # 注意：生产环境建议不直接暴露端口，通过 Nginx 统一代理
    # expose:
    #   - "3001"
    ports:
      - "${IM_CONNECT_PORT:-3001}:3001"  # 开发环境可保留，生产环境建议注释
    environment:
      - IM_CONNECT_CONFIG=/app/config.toml
      - RUST_LOG=${RUST_LOG:-info}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      - CONNECT_PORT=3001
      # 重要：JWT_SECRET 必须与 im-server 服务完全相同，用于验证 im-server 生成的 token
      - JWT_SECRET=${JWT_SECRET:-337eb69ef604dec5cdb04481242877fea7db31e4c1fd236497033431ab41d499}
      # 重要：JWT_EXPIRATION_HOURS 必须与 im-server 服务完全相同，统一 token 过期时间
      - JWT_EXPIRATION_HOURS=${JWT_EXPIRATION_HOURS:-24}
    depends_on:
      redis:
        condition: service_healthy
      mqtt:
        condition: service_healthy
    networks:
      - violet-network

  # ============================================
  # SRS (Simple Realtime Server) 服务
  # ============================================
  # 提供 WebRTC 音视频通话功能
  # 对外端口：通过 Nginx 代理 HTTP API，UDP 端口需要直接暴露
  srs:
    image: registry.cn-hangzhou.aliyuncs.com/ossrs/srs:6.0-d2
    container_name: violet-srs
    restart: unless-stopped
    ports:
      - "${SRS_RTMP_PORT:-1935}:1935"      # RTMP 端口
      - "${SRS_HTTP_API_PORT:-1985}:1985"  # HTTP API 端口
      - "${SRS_HTTP_PORT:-8080}:8080"      # HTTP 端口
      - "${SRS_HTTPS_PORT:-1990}:1990"     # HTTPS 端口
      - "${SRS_HTTP_API_SSL_PORT:-8088}:8088"  # HTTP API SSL 端口
      - "${SRS_WEBRTC_PORT:-8000}:8000/udp"    # WebRTC UDP 端口
    environment:
      # ⚠️ 重要：CANDIDATE 必须设置为物理机的实际 IP 地址（不是 127.0.0.1）
      # 这个 IP 用于 WebRTC 的 ICE 候选地址，客户端需要通过这个 IP 建立 WebRTC 连接
      # 在 .env 文件中设置 SRS_CANDIDATE=你的物理机IP，例如：SRS_CANDIDATE=192.168.1.9
      - CANDIDATE=${SRS_CANDIDATE:-127.0.0.1}  # 默认值仅用于开发环境，生产环境必须设置为物理机IP
    networks:
      - violet-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:1985/api/v1/versions || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # Nginx 反向代理服务
  # ============================================
  # 统一对外提供服务，聚合所有后端服务
  # 对外端口：80 (HTTP), 443 (HTTPS，需配置 SSL 证书)
  # 代理服务：
  #   - /api/*          -> im-server:3000 (所有业务逻辑，包括 WebRTC 相关 API)
  #   - /ws/*           -> im-connect:3001 (WebSocket)
  #   - /uploads/*      -> im-server:3000 (文件服务)
  # 注意：SRS 和 MQTT 不通过 Nginx 代理，由 im-server 内部调用
  nginx:
    image: nginx:alpine
    container_name: violet-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"  # 如果需要 HTTPS
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - violet-network
    depends_on:
      - im-server
      - im-connect
      - srs
    # 注意：
    # 1. Nginx 只代理 im-server 和 im-connect 的 HTTP/WebSocket 流量
    # 2. SRS 和 MQTT 不通过 Nginx 代理，由 im-server 内部调用
    # 3. WebRTC 的 UDP 连接（8000端口）由客户端通过 im-server 获取连接信息后建立
    # 4. 生产环境建议配置 SSL 证书启用 HTTPS

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  mqtt_data:
    driver: local
  mqtt_log:
    driver: local

networks:
  violet-network:
    driver: bridge

